## 判断过程
布隆过滤器（Bloom Filter）是一种空间高效的概率型数据结构，用于快速判断一个元素 “是否可能存在于集合中”。其核心流程包括**初始化、插入元素、查询元素**三个步骤，具体过程如下：

### 1. 初始化

- **创建位数组**：初始化一个长度为 `m` 的二进制数组（bit array），所有位默认置为 `0`。
- **选择哈希函数**：确定 `k` 个独立的哈希函数，每个函数能将任意输入元素映射到位数组的索引（范围 `[0, m-1]`）。

例：`m=10`，`k=3`，位数组初始状态：  
`[0, 0, 0, 0, 0, 0, 0, 0, 0, 0]`

### 2. 插入元素（Add）

当插入元素 `x` 时，执行以下操作：

  

1. 对元素 `x` 应用 `k` 个哈希函数，得到 `k` 个不同的位数组索引 `i₁, i₂, ..., iₖ`。
2. 将位数组中这些索引对应的位**置为 `1`**（若已为 `1` 则保持不变）。

例：插入元素 `x`，3 个哈希函数映射到索引 `2、5、7`，位数组变为：  
`[0, 0, 1, 0, 0, 1, 0, 1, 0, 0]`

### 3. 查询元素（Contains）

当查询元素 `y` 时，执行以下操作：

  

1. 对元素 `y` 应用同样的 `k` 个哈希函数，得到 `k` 个索引 `j₁, j₂, ..., jₖ`。
2. 检查位数组中这些索引对应的位：
    - **若所有位均为 `1`**：判断 “`y` 可能存在”（存在假阳性误判的可能）。
    - **若至少有一位为 `0`**：判断 “`y` 一定不存在”（结果绝对准确）。  

例：

- 查询元素 `y`，哈希映射到 `2、5、7` → 所有位为 `1` → “可能存在”。
- 查询元素 `z`，哈希映射到 `2、5、8` → 位 `8` 为 `0` → “一定不存在”。

## 概率计算
布隆过滤器的误判率公式是基于概率统计推导的，核心思路是计算 “一个不存在的元素被误判为存在” 的概率。以下是详细推导过程：

### 前提假设

1. 位数组长度为 `m`，初始全为 0。
2. 使用 `k` 个独立的哈希函数，每个函数将元素均匀映射到位数组的 `m` 个位置（每个位置被选中的概率为 `1/m`）。
3. 已插入 `n` 个元素，且所有哈希映射和插入操作均独立。

### 推导步骤

#### 1. 单个位在插入一个元素后仍为 0 的概率

- 一个哈希函数将元素映射到某特定位的概率为 `1/m`，则**不映射到该位**的概率为 `1 - 1/m`。
- 插入一个元素时，`k` 个哈希函数都**不映射到某特定位**的概率为 `(1 - 1/m)^k`。

#### 2. 单个位在插入 `n` 个元素后仍为 0 的概率

- 插入 `n` 个元素后，所有 `n×k` 次哈希映射都**不涉及某特定位**的概率为 `[(1 - 1/m)^k]^n = (1 - 1/m)^{kn}`。

#### 3. 单个位在插入 `n` 个元素后被置为 1 的概率

- 与 “仍为 0” 的概率互补，即 `1 - (1 - 1/m)^{kn}`。

#### 4. 误判率（假阳性概率）

误判发生在：一个**未插入的元素**，其 `k` 个哈希映射对应的位**全部被之前的元素置为 1**。

  

- 由于哈希函数独立，且未插入元素的映射与已有元素无关，每个映射位被置为 1 的概率为 `1 - (1 - 1/m)^{kn}`。
- 因此，`k` 个映射位**全部为 1** 的概率（即误判率 `p`）为：
$$
p = \left[1 - \left(1 - \frac{1}{m}\right)^{kn}\right]^k
$$


#### 5. 近似简化（当 `m` 较大时）

当 `m` 很大时，`1/m` 趋近于 0，利用极限公式 `limₓ→0 (1 - x)^(1/x) = e⁻¹`，可得近似：  
`(1 - 1/m)^m ≈ e⁻¹` → `(1 - 1/m) ≈ e^(-1/m)`。

代入误判率公式：

$$
p \approx \left[1 - e^{-kn/m}\right]^k
$$

### 最优哈希函数数量 `k`

为最小化误判率，对 `p` 关于 `k` 求导并令导数为 0，可得最优 `k` 为：

  
$$
k = \frac{m}{n} \ln 2
$$


此时最小误判率为：

  

$$
p_{\text{min}} = \left(\frac{1}{2}\right)^k = e^{-k \ln 2} = 2^{- \frac{m}{n} \cdot (\ln 2)^2}
$$


### 总结

误判率公式的核心是**计算 “未插入元素的所有哈希位被已有元素占用” 的概率**，其推导基于独立事件的概率乘法原理和极限近似。实际使用中，可根据允许的误判率 `p`、元素数量 `n`，通过公式反推所需的位数组长度 `m` 和哈希函数数量 `k`。